%file alias
F00=*
F01=c:\users\mde\desktop\git\domotica-cutouch-plc-shutters\shutterio.inc
F02=c:\users\mde\desktop\git\domotica-cutouch-plc-shutters\shutterscreen.inc
%preprocessed source
F00000006Const Device = CT1720
F00000007Ramclear
F00000008Set Debug Off
F00000011Dim StringByte As String
F00000012Dim stringByteTmp As String
F00000015Dim iocounter As Byte
F00000018Dim Clock As Integer
F00000019Dim SavedTime As Integer
F00000020Dim LightOff As Byte
F00000023Dim TX1 As Integer
F00000024Dim TY1 As Integer
F00000025Dim upStatusForTouch As Byte
F00000026Dim downStatusForTouch As Byte
F00000027Dim menuselected As Integer
F00000028Dim menuselectedprevious As Integer
F00000029Dim touchInput As Byte
F00000032Dim statusofshutterupword As String
F00000033Dim statusofshuttersdownword As String
F00000034Dim statusofshutterstotal As String
F00000037Dim message As String
F00000038message = "Desynchronized"
F00000040Dim prequal As String
F00000041prequal = "SHUTTER"
F00000046Dim achterkamer As String
F00000047achterkamer = "56"
F00000049Dim slaapkamer As String
F00000050slaapkamer = "57"
F00000052Dim keuken As String
F00000053keuken = "60"
F00000055Dim livingTuin As String
F00000056livingTuin = "630"
F00000058Dim livingTerras As String
F00000059livingTerras = "631"
F00000061Dim livingVoordeur As String
F00000062livingVoordeur = "632"
F00000064Dim garage As String
F00000065garage = "67"
F00000067Dim badkamerGroot As String
F00000068badkamerGroot = "640"
F00000070Dim badkamerKlein As String
F00000071badkamerKlein = "641"
F00000073Dim bovenKamerWork As String
F00000074bovenKamerWork = "75"
F00000076Dim bovenSlaapkamer As String
F00000077bovenSlaapkamer = "79"
F00000125Delay 200
F01000003Usepin 56,In,OmhoogAchterkamer
F01000004Usepin 57,In,OmlaagAchterkamer
F01000005Usepin 58,In,OmhoogSlaapkamer
F01000006Usepin 59,In,OmlaagSlaapkamer
F01000007Usepin 60,In,OmhoogKeuken
F01000008Usepin 61,In,OmlaagKeuken
F01000009Usepin 62,In,OmhoogLivingTuin
F01000010Usepin 63,In,OmlaagLivingTuin
F01000011Usepin 64,In,OmhoogLivingTerras
F01000012Usepin 65,In,OmlaagLivingTerras
F01000013Usepin 66,In,OmhoogLivingVoordeur
F01000014Usepin 67,In,OmlaagLivingVoordeur
F01000015Usepin 68,In,OmhoogBadkamerGroot
F01000016Usepin 69,In,OmlaagBadkamerGroot
F01000017Usepin 70,In,OmhoogBadkamerKlein
F01000018Usepin 71,In,OmlaagBadkamerKlein
F01000019Usepin 72,In,OmhoogGarage
F01000020Usepin 73,In,OmlaagGarage
F01000021Usepin 74,In,OmhoogBovenkamerWork
F01000022Usepin 75,In,OmlaagBovenkamerWork
F01000023Usepin 76,In,OmhoogBovenSlaapkamer
F01000024Usepin 77,In,OmlaagBovenSlaapkamer
F01000027Usepin 24,Out,RelaisOmhoogAchterkamer
F01000028Usepin 25,Out,RelaisOmlaagAchterkamer
F01000029Usepin 26,Out,RelaisOmhoogSlaapkamer
F01000030Usepin 27,Out,RelaisOmlaagSlaapkamer
F01000031Usepin 28,Out,RelaisOmhoogKeuken
F01000032Usepin 29,Out,RelaisOmlaagKeuken
F01000033Usepin 30,Out,RelaisOmhoogLivingTuin
F01000034Usepin 31,Out,RelaisOmlaagLivingTuin
F01000035Usepin 32,Out,RelaisOmhoogLivingTerras
F01000036Usepin 33,Out,RelaisOmlaagLivingTerras
F01000037Usepin 34,Out,RelaisOmhoogLivingVoordeur
F01000038Usepin 35,Out,RelaisOmlaagLivingVoordeur
F01000039Usepin 36,Out,RelaisOmhoogBadkamerGroot
F01000040Usepin 37,Out,RelaisOmlaagBadkamerGroot
F01000041Usepin 38,Out,RelaisOmhoogBadkamerKlein
F01000042Usepin 39,Out,RelaisOmlaagBadkamerKlein
F01000043Usepin 40,Out,RelaisOmhoogGarage
F01000044Usepin 41,Out,RelaisOmlaagGarage
F01000045Usepin 42,Out,RelaisOmhoogBovenkamerWork
F01000046Usepin 43,Out,RelaisOmlaagBovenkamerWork
F01000047Usepin 44,Out,RelaisOmhoogBovenSlaapkamer
F01000048Usepin 45,Out,RelaisOmlaagBovenSlaapkamer
F00000130InitializeSerialCommunication
F00000133touchInput = 0
F00000136_D(200) = 30
F00000137_D(201) = 159
F00000138_D(202) = 156
F00000139_D(203) = 182
F00000140_D(204) = 172
F00000141_D(205) = 141
F00000142_D(206) = 139
F00000143_D(207) = 100
F00000144_D(208) = 100
F00000145_D(209) = 202
F00000146_D(210) = 181
F00000147_D(211) = 100
F00000148_D(212) = 100
F00000149_D(213) = 170
F00000150_D(214) = 156
F00000151_D(215) = 130
F00000152_D(216) = 127
F00000153_D(217) = 140
F00000154_D(218) = 135
F00000155_D(219) = 100
F00000156_D(220) = 100
F00000157_D(221) = 100
F00000158_D(222) = 100
F00000160Set Outonly On
F00000161Set Ladder On
F00000163On Ladderint Gosub DoLadderInt
F00000164On Timer(10) Gosub EVERY100ms
F00000167Set Pad 0,4,20
F00000170Drawscreen
F00000171On Pad Gosub TouchScreen
F00000174Do
F00000175Loop
F00000178DoLadderInt:
F00000180Calculation achterkamer,	 0, 2, 3, 4, 6, 7, 8, 159, 156
F00000181Calculation slaapkamer, 	 10, 12, 13, 14, 16, 17, 18, 182, 172
F00000182Calculation keuken,         20, 22, 23, 24, 26, 27, 28, 141, 139
F00000183Calculation livingTuin,     30, 32, 33, 34, 36, 37, 38, 100, 100
F00000184Calculation livingTerras,   40, 42, 43, 44, 46, 47, 48, 202, 181
F00000185Calculation livingVoordeur, 50, 52, 53, 54, 56, 57, 58, 100, 100
F00000186Calculation badkamerGroot,  60, 62, 63, 64, 66, 67, 68, 170, 156
F00000187Calculation badkamerKlein,  70, 72, 73, 74, 76, 77, 78, 130, 127
F00000188Calculation garage,       	 80, 82, 83, 84, 86, 87, 88, 140, 135
F00000189Calculation bovenKamerWork,  90, 92, 93, 94, 96, 97, 98, 100, 100
F00000190Calculation bovenSlaapkamer, 100, 102, 103, 104, 106, 107, 108, 100, 100
F00000192Return
F00000195SERIALINTERRUPT:
F00000197Debug "Response: "
F00000198Do While Blen(1,0) > 0
F00000200stringByteTmp = Getstr(1,1000)
F00000201If (stringByteTmp <> "<") Then
F00000202StringByte = StringByte + stringByteTmp
F00000203Else
F00000205If (Val(StringByte) = 1000) Then
F00000206Debug "All Up"
F00000207AllUp
F00000208Elseif (Val(StringByte) = 2000) Then
F00000209Debug "ALL Down"
F00000210AllDown
F00000211Else
F00000212For iocounter = 56 To 77
F00000213If Val(StringByte) = iocounter Then
F00000214Debug "Valid value"
F00000215_M(iocounter) = 1
F00000216End If
F00000217Next
F00000218End If
F00000220StringByte = ""
F00000221End If
F00000222Debug StringByte, " "
F00000223Loop
F00000224Debug Cr
F00000225Return
F00000228EVERY100ms:
F00000229Incr Clock
F00000231If Clock-SavedTime>200 Then
F00000232LightOff=1
F00000233Light 0
F00000234End If
F00000235Return
F00000238TouchScreen:
F00000239Set OnPad Off
F00000240TX1 = Getpad(2)
F00000241TY1 = Getpad(2)
F00000243If LightOff=1 Then
F00000244SavedTime=Clock
F00000245LightOff=0
F00000246Light 1
F00000247touchInput = 0
F00000248Else
F00000249SavedTime=Clock
F00000250touchInput = 1
F00000251End If
F00000253If touchInput = 1 Then
F00000255If Menucheck(97, TX1, TY1) = 1 Then
F00000256Pulsout 18,150
F00000257AllUp
F00000259Elseif Menucheck(98, TX1, TY1) = 1 Then
F00000260Pulsout 18,150
F00000261AllDown
F00000262Elseif Menucheck(100, TX1, TY1) = 1 Then
F00000263Pulsout 18,150
F00000264_M(upStatusForTouch) = 1
F00000266Elseif Menucheck(101, TX1, TY1) = 1 Then
F00000267Pulsout 18,150
F00000268_M(downStatusForTouch) = 1
F00000269Else
F00000270CheckTouchScreen
F00000271End If
F00000272End If
F00000273Set OnPad On
F00000274Return
F00000276End
F00000281Sub InitializeSerialCommunication()
F00000282Opencom 1,115200,3,80,1024
F00000283Set Rs232 1, 115200, 3
F00000284Putstr 1,"SHUTTER PLC ONLINE", Chr(13), Chr(10)
F00000285SendMessage message
F00000286On Recv1 Gosub SERIALINTERRUPT
F00000287End Sub
F00000289Sub SendOutSerial(shutter As String, up As String, down As String, total As String)
F00000291Putstr 1, prequal, "*", shutter, "=", up , "-", down, "-", total, Chr(13), Chr(10)
F00000292End Sub
F00000296Sub Calculation(room As String, counterIncrease As Byte, statusup As Byte, previousStatusUp As Byte, counterDown As Byte, statusdown As Byte, previousStatusDown As Byte, percentageStatus As Byte, shutterUpCalibration As Integer, shutterDownCalibration As Integer)
F00000298If _D(previousStatusUp) > _D(statusup) Or _D(previousStatusDown) > _D(statusdown) Then
F00000300SendOutSerial room, Hex _D(statusup), Hex _D(statusdown), Hex _D(percentageStatus)
F00000301Debug "Up ", Dec _D(statusup), "% - ", "Down ", Dec _D(statusdown), "% - ", "Status ", Dec _D(percentageStatus), "% ", room, Cr
F00000302_D(previousStatusUp) = 0
F00000303_D(previousStatusDown) = 0
F00000304End If
F00000306If _D(counterIncrease) > 0 Or _D(counterDown) > 0 Then
F00000307_D(statusup) = (_D(counterIncrease) * 10) / shutterUpCalibration
F00000308_D(statusdown) = (_D(counterDown) * 10) / shutterDownCalibration
F00000310If _D(previousStatusUp) <> _D(statusup) Or _D(previousStatusDown) <> _D(statusdown) Then
F00000311SendOutSerial room, Hex _D(statusup), Hex _D(statusdown), Hex _D(percentageStatus)
F00000312Debug "Up ", Dec _D(statusup), "% - ", "Down ", Dec _D(statusdown), "% - ", "Status ", Dec _D(percentageStatus), "% ", room, Cr
F00000313_D(previousStatusUp) = _D(statusup)
F00000314_D(previousStatusDown) = _D(statusdown)
F00000315Endif
F00000316Endif
F00000318End Sub
F00000321Sub AllDown()
F00000322message = "UPSynchronizing"
F00000323SendMessage message
F00000324For iocounter = 56 To 77
F00000325If ((iocounter / 2) * 2 <> iocounter) Then
F00000326If _M(iocounter) <> 1 Then
F00000327_M(iocounter) = 1
F00000328Debug "allup"
F00000329End If
F00000330End If
F00000331Next
F00000332End Sub
F00000335Sub AllUp()
F00000336message = "DownSynchronizing"
F00000337SendMessage message
F00000338For iocounter = 56 To 77
F00000339If ((iocounter / 2) * 2 = iocounter) Then
F00000340If _M(iocounter) <> 1 Then
F00000341_M(iocounter) = 1
F00000342Debug "alldown"
F00000343End If
F00000344End If
F00000345Next
F00000346End Sub
F00000349Sub CheckTouchScreen()
F00000350Glocate 20,110
F00000351Debug "Checking touchscreen"
F00000352If Menucheck(Val(achterkamer),TX1,TY1) = 1 Then
F00000353upStatusForTouch = 56
F00000354downStatusForTouch = 57
F00000355menuselected = Val(achterkamer)
F00000356ReverseMenu
F00000357Elseif Menucheck(Val(slaapkamer),TX1,TY1) = 1 Then
F00000358upStatusForTouch = 58
F00000359downStatusForTouch = 59
F00000360menuselected = Val(slaapkamer)
F00000361ReverseMenu
F00000362Elseif Menucheck(Val(keuken),TX1,TY1) = 1 Then
F00000363upStatusForTouch = 60
F00000364downStatusForTouch = 61
F00000365menuselected = Val(keuken)
F00000366ReverseMenu
F00000367Elseif Menucheck(Val(livingTuin),TX1,TY1) = 1 Then
F00000368upStatusForTouch = 62
F00000369downStatusForTouch = 63
F00000370menuselected = Val(livingTuin)
F00000371ReverseMenu
F00000372Elseif Menucheck(Val(livingTerras),TX1,TY1) = 1 Then
F00000373upStatusForTouch = 64
F00000374downStatusForTouch = 65
F00000375menuselected = Val(livingTerras)
F00000376ReverseMenu
F00000377Elseif Menucheck(Val(livingVoordeur),TX1,TY1) = 1 Then
F00000378upStatusForTouch = 66
F00000379downStatusForTouch = 67
F00000380menuselected = Val(livingVoordeur)
F00000381ReverseMenu
F00000382Elseif Menucheck(640,TX1,TY1) = 1 Then
F00000383upStatusForTouch = 68
F00000384downStatusForTouch = 69
F00000385menuselected = 640
F00000386ReverseMenu
F00000387Elseif Menucheck(641,TX1,TY1) = 1 Then
F00000388upStatusForTouch = 70
F00000389downStatusForTouch = 71
F00000390menuselected = 641
F00000391ReverseMenu
F00000392Elseif Menucheck(Val(garage),TX1,TY1) = 1 Then
F00000393upStatusForTouch = 72
F00000394downStatusForTouch = 73
F00000395menuselected = Val(garage)
F00000396ReverseMenu
F00000397Elseif Menucheck(Val(bovenKamerWork),TX1,TY1) = 1 Then
F00000398upStatusForTouch = 74
F00000399downStatusForTouch = 75
F00000400menuselected = Val(bovenKamerWork)
F00000401ReverseMenu
F00000402Elseif Menucheck(Val(bovenSlaapkamer),TX1,TY1) = 1 Then
F00000403upStatusForTouch = 76
F00000404downStatusForTouch = 77
F00000405menuselected = Val(bovenSlaapkamer)
F00000406ReverseMenu
F00000407Endif
F00000408End Sub
F00000411Sub SendMessage(messageSerial As String)
F00000412SendOutSerial messageSerial, 0, 0, 0
F00000413End Sub
F00000416Sub ReverseMenu()
F00000417If menuselected <> 0 Then
F00000418Menureverse menuselected
F00000419If menuselectedprevious <> 0 Then
F00000420Menureverse menuselectedprevious
F00000421End If
F00000422menuselectedprevious = menuselected
F00000423End If
F00000424End Sub
F02000001SUB DrawScreen()
F02000002LINESTYLE 0
F02000003DOTSIZE 0,0
F02000004COLOR 1
F02000005BOX 170,10,310,230
F02000006FONT 0,1
F02000007STYLE 2,0,0
F02000008MENUSET 56,1,245,15,305,70
F02000009MENUTITLE 56,23,19,"AK"
F02000010MENUSET 57,1,245,75,305,130
F02000011MENUTITLE 57,23,19,"SK"
F02000012MENUSET 60,1,245,135,305,170
F02000013MENUTITLE 60,23,9,"KS"
F02000014MENUSET 630,1,245,175,305,205
F02000015MENUTITLE 630,23,7,"LT"
F02000016MENUSET 632,1,175,175,240,205
F02000017MENUTITLE 632,25,7,"LV"
F02000018MENUSET 640,1,175,120,240,170
F02000019MENUTITLE 640,25,17,"BK-G"
F02000020MENUSET 641,1,175,55,240,115
F02000021MENUTITLE 641,22,22,"BK-K"
F02000022MENUSET 67,1,175,15,240,50
F02000023MENUTITLE 67,22,9,"GAR"
F02000024MENUSET 631,1,175,210,305,225
F02000025MENUTITLE 631,58,0,"LL"
F02000026FONT 0,0
F02000027GLOCATE 20,110
F02000028GPRINT "   MDE Shutter"
F02000029GLOCATE 20,126
F02000030GPRINT "      V1.2.1"
F02000031STYLE 0,0,0
F02000032MENUSET 97,2,5,200,80,235
F02000033MENUTITLE 97,16,9,"ALL UP"
F02000034MENUSET 98,2,85,200,160,235
F02000035MENUTITLE 98,9,9,"ALL DOWN"
F02000036BOX 5,150,160,195
F02000037FONT 0,1
F02000038STYLE 2,0,0
F02000039MENUSET 75,1,10,155,80,190
F02000040MENUTITLE 75,10,9,"Bov WRK"
F02000041MENUSET 79,1,90,155,155,190
F02000042MENUTITLE 79,7,9,"Bov SLK"
F02000043MENUSET 100,1,10,5,75,90
F02000044MENUTITLE 100,25,34,"UP"
F02000045MENUSET 101,1,90,5,155,90
F02000046MENUTITLE 101,18,34,"DOWN"
F02000047BOX 5,0,160,95
F02000048FONT 4,0
F02000049STYLE 0,0,0
F02000050END SUB
F99000000End
F99000021Sub Pulsout(__pt As Byte, __ln As Word)
F99000022Dim __dl1 As Integer
F99000023Reverse __pt
F99000024For __dl1=0 To __ln
F99000025Next
F99000026Reverse __pt
F99000027End Sub
F99000030Sub Delay(__dl As Long)
F99000031__dl1 Var Long
F99000032__dl2 Var Integer
F99000033For __dl1=0 To __dl
F99000034For __dl2=0 To 1
F99000035Nop
F99000036Nop
F99000037Nop
F99000038Next
F99000039Next
F99000040End Sub