%file alias
F00=*
F01=c:\users\mde\desktop\git\domotica-cutouch-plc-shutters\shutterio.inc
F02=c:\users\mde\desktop\git\domotica-cutouch-plc-shutters\shutterscreen.inc
%preprocessed source
F00000005Const Device = CT1720
F00000006Ramclear
F00000007Set Debug On
F00000010Dim StringByte As String
F00000011Dim stringByteTmp As String
F00000014Dim iocounter As Byte
F00000017Dim Clock As Integer
F00000018Dim SavedTime As Integer
F00000019Dim LightOff As Byte
F00000022Dim TX1 As Integer
F00000023Dim TY1 As Integer
F00000024Dim upStatusForTouch As Byte
F00000025Dim downStatusForTouch As Byte
F00000026Dim menuselected As Integer
F00000027Dim menuselectedprevious As Integer
F00000030Dim statusofshutterupword As String
F00000031Dim statusofshuttersdownword As String
F00000032Dim statusofshutterstotal As String
F00000035Dim message As String
F00000036message = "Desynchronized"
F00000038Dim prequal As String
F00000039prequal = "SHUTTER"
F00000043Dim achterkamer As String
F00000044achterkamer = "56"
F00000046Dim slaapkamer As String
F00000047slaapkamer = "57"
F00000049Dim keuken As String
F00000050keuken = "60"
F00000052Dim livingTuin As String
F00000053livingTuin = "630"
F00000055Dim livingTerras As String
F00000056livingTerras = "631"
F00000058Dim livingVoordeur As String
F00000059livingVoordeur = "632"
F00000061Dim garage As String
F00000062garage = "67"
F00000064Dim badkamerGroot As String
F00000065badkamerGroot = "690"
F00000067Dim badkamerKlein As String
F00000068badkamerKlein = "691"
F00000070Dim bovenKamerWork As String
F00000071bovenKamerWork = "75"
F00000073Dim bovenSlaapkamer As String
F00000074bovenSlaapkamer = "79"
F00000121Delay 200
F01000003Usepin 56,In,OmhoogAchterkamer
F01000004Usepin 57,In,OmlaagAchterkamer
F01000005Usepin 58,In,OmhoogSlaapkamer
F01000006Usepin 59,In,OmlaagSlaapkamer
F01000007Usepin 60,In,OmhoogKeuken
F01000008Usepin 61,In,OmlaagKeuken
F01000009Usepin 62,In,OmhoogLivingTuin
F01000010Usepin 63,In,OmlaagLivingTuin
F01000011Usepin 64,In,OmhoogLivingTerras
F01000012Usepin 65,In,OmlaagLivingTerras
F01000013Usepin 66,In,OmhoogLivingVoordeur
F01000014Usepin 67,In,OmlaagLivingVoordeur
F01000015Usepin 68,In,OmhoogGarage
F01000016Usepin 69,In,OmlaagGarage
F01000017Usepin 70,In,OmhoogBadkamerGroot
F01000018Usepin 71,In,OmlaagBadkamerGroot
F01000019Usepin 72,In,OmhoogBadkamerKlein
F01000020Usepin 73,In,OmlaagBadkamerKlein
F01000021Usepin 74,In,OmhoogBovenkamerWork
F01000022Usepin 75,In,OmlaagBovenkamerWork
F01000023Usepin 76,In,OmhoogBovenSlaapkamer
F01000024Usepin 77,In,OmlaagBovenSlaapkamer
F01000027Usepin 24,Out,RelaisOmhoogAchterkamer
F01000028Usepin 25,Out,RelaisOmlaagAchterkamer
F01000029Usepin 26,Out,RelaisOmhoogSlaapkamer
F01000030Usepin 27,Out,RelaisOmlaagSlaapkamer
F01000031Usepin 28,Out,RelaisOmhoogKeuken
F01000032Usepin 29,Out,RelaisOmlaagKeuken
F01000033Usepin 30,Out,RelaisOmhoogLivingTuin
F01000034Usepin 31,Out,RelaisOmlaagLivingTuin
F01000035Usepin 32,Out,RelaisOmhoogLivingTerras
F01000036Usepin 33,Out,RelaisOmlaagLivingTerras
F01000037Usepin 34,Out,RelaisOmhoogLivingVoordeur
F01000038Usepin 35,Out,RelaisOmlaagLivingVoordeur
F01000039Usepin 36,Out,RelaisOmhoogGarage
F01000040Usepin 37,Out,RelaisOmlaagGarage
F01000041Usepin 38,Out,RelaisOmhoogBadkamerGroot
F01000042Usepin 39,Out,RelaisOmlaagBadkamerGroot
F01000043Usepin 40,Out,RelaisOmhoogBadkamerKlein
F01000044Usepin 41,Out,RelaisOmlaagBadkamerKlein
F01000045Usepin 42,Out,RelaisOmhoogBovenkamerWork
F01000046Usepin 43,Out,RelaisOmlaagBovenkamerWork
F01000047Usepin 44,Out,RelaisOmhoogBovenSlaapkamer
F01000048Usepin 45,Out,RelaisOmlaagBovenSlaapkamer
F00000126InitializeSerialCommunication
F00000129_D(200) = 30
F00000130_D(201) = 100
F00000131_D(202) = 100
F00000132_D(203) = 182
F00000133_D(204) = 172
F00000134_D(205) = 141
F00000135_D(206) = 139
F00000136_D(207) = 100
F00000137_D(208) = 100
F00000138_D(209) = 202
F00000139_D(210) = 181
F00000140_D(211) = 100
F00000141_D(212) = 100
F00000142_D(213) = 100
F00000143_D(214) = 100
F00000144_D(215) = 100
F00000145_D(216) = 100
F00000146_D(217) = 100
F00000147_D(218) = 100
F00000148_D(219) = 100
F00000149_D(220) = 100
F00000150_D(221) = 100
F00000151_D(222) = 100
F00000153Set Outonly On
F00000154Set Ladder On
F00000156On Ladderint Gosub DoLadderInt
F00000157On Timer(10) Gosub EVERY100ms
F00000160Set Pad 0,4,20
F00000162Drawscreen
F00000163On Pad Gosub TouchScreen
F00000165Do
F00000166Loop
F00000169DoLadderInt:
F00000171Calculation achterkamer,	 0, 2, 3, 4, 6, 7, 8, 100, 100
F00000172Calculation slaapkamer, 	 10, 12, 13, 14, 16, 17, 18, 182, 172
F00000173Calculation keuken,         20, 22, 23, 24, 26, 27, 28, 141, 139
F00000174Calculation livingTuin,     30, 32, 33, 34, 36, 37, 38, 100, 100
F00000175Calculation livingTerras,   40, 42, 43, 44, 46, 47, 48, 202, 181
F00000176Calculation livingVoordeur, 50, 52, 53, 54, 56, 57, 58, 100, 100
F00000177Calculation garage,       	 60, 62, 63, 64, 66, 67, 68, 100, 100
F00000178Calculation badkamerGroot,  70, 72, 73, 74, 76, 77, 78, 100, 100
F00000179Calculation badkamerKlein,  80, 82, 83, 84, 86, 87, 88, 100, 100
F00000180Calculation bovenKamerWork,  90, 92, 93, 94, 96, 97, 98, 100, 100
F00000181Calculation bovenSlaapkamer, 100, 102, 103, 104, 106, 107, 108, 100, 100
F00000183Return
F00000186SERIALINTERRUPT:
F00000188Debug "Response: "
F00000189Do While Blen(1,0) > 0
F00000191stringByteTmp = Getstr(1,1000)
F00000192If (stringByteTmp <> "<") Then
F00000193StringByte = StringByte + stringByteTmp
F00000194Else
F00000196If (Val(StringByte) = 1000) Then
F00000197Debug "All Up"
F00000198AllUp
F00000199Elseif (Val(StringByte) = 2000) Then
F00000200Debug "ALL Down"
F00000201AllDown
F00000202Else
F00000203For iocounter = 56 To 77
F00000204If Val(StringByte) = iocounter Then
F00000205Debug "Valid value"
F00000206_M(iocounter) = 1
F00000207End If
F00000208Next
F00000209End If
F00000211StringByte = ""
F00000212End If
F00000213Debug StringByte, " "
F00000214Loop
F00000215Debug Cr
F00000216Return
F00000219EVERY100ms:
F00000220Incr Clock
F00000222If Clock-SavedTime>200 Then
F00000223LightOff=1
F00000224Light 0
F00000225End If
F00000226Return
F00000229TouchScreen:
F00000230Set OnPad Off
F00000231TX1 = Getpad(2)
F00000232TY1 = Getpad(2)
F00000233If LightOff=1 Then
F00000234SavedTime=Clock
F00000235LightOff=0
F00000236Light 1
F00000237Else
F00000238SavedTime=Clock
F00000239End If
F00000242If Menucheck(97, TX1, TY1) = 1 Then
F00000243Pulsout 18,150
F00000244AllUp
F00000246Elseif Menucheck(98, TX1, TY1) = 1 Then
F00000247Pulsout 18,150
F00000248AllDown
F00000249Elseif Menucheck(100, TX1, TY1) = 1 Then
F00000250Pulsout 18,150
F00000251_M(upStatusForTouch) = 1
F00000253Elseif Menucheck(101, TX1, TY1) = 1 Then
F00000254Pulsout 18,150
F00000255_M(downStatusForTouch) = 1
F00000256Else
F00000257CheckTouchScreen
F00000258End If
F00000259Set OnPad On
F00000260Return
F00000262End
F00000267Sub InitializeSerialCommunication()
F00000268Opencom 1,115200,3,80,1024
F00000269Set Rs232 1, 115200, 3
F00000270Putstr 1,"SHUTTER PLC ONLINE", Chr(13), Chr(10)
F00000271SendMessage message
F00000272On Recv1 Gosub SERIALINTERRUPT
F00000273End Sub
F00000275Sub SendOutSerial(shutter As String, up As String, down As String, total As String)
F00000277Putstr 1, prequal, "*", shutter, "=", up , "-", down, "-", total, Chr(13), Chr(10)
F00000280End Sub
F00000284Sub Calculation(room As String, counterIncrease As Byte, statusup As Byte, previousStatusUp As Byte, counterDown As Byte, statusdown As Byte, previousStatusDown As Byte, percentageStatus As Byte, shutterUpCalibration As Integer, shutterDownCalibration As Integer)
F00000286If _D(previousStatusUp) > _D(statusup) Or _D(previousStatusDown) > _D(statusdown) Then
F00000288SendOutSerial room, Hex _D(statusup), Hex _D(statusdown), Hex _D(percentageStatus)
F00000289Debug "Up ", Dec _D(statusup), "% - ", "Down ", Dec _D(statusdown), "% - ", "Status ", Dec _D(percentageStatus), "% ", room, Cr
F00000290_D(previousStatusUp) = 0
F00000291_D(previousStatusDown) = 0
F00000292End If
F00000294If _D(counterIncrease) > 0 Or _D(counterDown) > 0 Then
F00000295_D(statusup) = (_D(counterIncrease) * 10) / shutterUpCalibration
F00000296_D(statusdown) = (_D(counterDown) * 10) / shutterDownCalibration
F00000298If _D(previousStatusUp) <> _D(statusup) Or _D(previousStatusDown) <> _D(statusdown) Then
F00000299SendOutSerial room, Hex _D(statusup), Hex _D(statusdown), Hex _D(percentageStatus)
F00000300Debug "Up ", Dec _D(statusup), "% - ", "Down ", Dec _D(statusdown), "% - ", "Status ", Dec _D(percentageStatus), "% ", room, Cr
F00000301_D(previousStatusUp) = _D(statusup)
F00000302_D(previousStatusDown) = _D(statusdown)
F00000303Endif
F00000304Endif
F00000306End Sub
F00000309Sub AllDown()
F00000310message = "UPSynchronizing"
F00000311SendMessage message
F00000312For iocounter = 56 To 77
F00000313If ((iocounter / 2) * 2 <> iocounter) Then
F00000314If _M(iocounter) <> 1 Then
F00000315_M(iocounter) = 1
F00000316Debug "allup"
F00000317End If
F00000318End If
F00000319Next
F00000320End Sub
F00000323Sub AllUp()
F00000324message = "DownSynchronizing"
F00000325SendMessage message
F00000326For iocounter = 56 To 77
F00000327If ((iocounter / 2) * 2 = iocounter) Then
F00000328If _M(iocounter) <> 1 Then
F00000329_M(iocounter) = 1
F00000330Debug "alldown"
F00000331End If
F00000332End If
F00000333Next
F00000334End Sub
F00000337Sub CheckTouchScreen()
F00000338Glocate 20,110
F00000339Debug "Checking touchscreen"
F00000340If Menucheck(Val(achterkamer),TX1,TY1) = 1 Then
F00000341upStatusForTouch = 56
F00000342downStatusForTouch = 57
F00000343menuselected = Val(achterkamer)
F00000344ReverseMenu
F00000345Elseif Menucheck(Val(slaapkamer),TX1,TY1) = 1 Then
F00000346upStatusForTouch = 58
F00000347downStatusForTouch = 59
F00000348menuselected = Val(slaapkamer)
F00000349ReverseMenu
F00000350Elseif Menucheck(Val(keuken),TX1,TY1) = 1 Then
F00000351upStatusForTouch = 60
F00000352downStatusForTouch = 61
F00000353menuselected = Val(keuken)
F00000354ReverseMenu
F00000355Elseif Menucheck(Val(livingTuin),TX1,TY1) = 1 Then
F00000356upStatusForTouch = 62
F00000357downStatusForTouch = 63
F00000358menuselected = Val(livingTuin)
F00000359ReverseMenu
F00000360Elseif Menucheck(Val(livingTerras),TX1,TY1) = 1 Then
F00000361upStatusForTouch = 64
F00000362downStatusForTouch = 65
F00000363menuselected = Val(livingTerras)
F00000364ReverseMenu
F00000365Elseif Menucheck(Val(livingVoordeur),TX1,TY1) = 1 Then
F00000366upStatusForTouch = 66
F00000367downStatusForTouch = 67
F00000368menuselected = Val(livingVoordeur)
F00000369ReverseMenu
F00000370Elseif Menucheck(Val(garage),TX1,TY1) = 1 Then
F00000371upStatusForTouch = 68
F00000372downStatusForTouch = 69
F00000373menuselected = Val(garage)
F00000374ReverseMenu
F00000375Elseif Menucheck(640,TX1,TY1) = 1 Then
F00000376upStatusForTouch = 70
F00000377downStatusForTouch = 71
F00000378menuselected = 640
F00000379ReverseMenu
F00000380Elseif Menucheck(641,TX1,TY1) = 1 Then
F00000381upStatusForTouch = 72
F00000382downStatusForTouch = 73
F00000383menuselected = 641
F00000384ReverseMenu
F00000385Elseif Menucheck(Val(bovenKamerWork),TX1,TY1) = 1 Then
F00000386upStatusForTouch = 74
F00000387downStatusForTouch = 75
F00000388menuselected = Val(bovenKamerWork)
F00000389ReverseMenu
F00000390Elseif Menucheck(Val(bovenSlaapkamer),TX1,TY1) = 1 Then
F00000391upStatusForTouch = 76
F00000392downStatusForTouch = 77
F00000393menuselected = Val(bovenSlaapkamer)
F00000394ReverseMenu
F00000395Endif
F00000396End Sub
F00000399Sub SendMessage(messageSerial As String)
F00000400SendOutSerial messageSerial, 0, 0, 0
F00000401End Sub
F00000404Sub ReverseMenu()
F00000405If menuselected <> 0 Then
F00000406Menureverse menuselected
F00000407If menuselectedprevious <> 0 Then
F00000408Menureverse menuselectedprevious
F00000409End If
F00000410menuselectedprevious = menuselected
F00000411End If
F00000412End Sub
F02000001SUB DrawScreen()
F02000002LINESTYLE 0
F02000003DOTSIZE 0,0
F02000004COLOR 1
F02000005BOX 170,10,310,230
F02000006FONT 0,1
F02000007STYLE 2,0,0
F02000008MENUSET 56,1,245,15,305,70
F02000009MENUTITLE 56,23,19,"AK"
F02000010MENUSET 57,1,245,75,305,130
F02000011MENUTITLE 57,23,19,"SK"
F02000012MENUSET 60,1,245,135,305,170
F02000013MENUTITLE 60,23,9,"KS"
F02000014MENUSET 630,1,245,175,305,205
F02000015MENUTITLE 630,23,7,"LT"
F02000016MENUSET 632,1,175,175,240,205
F02000017MENUTITLE 632,25,7,"LV"
F02000018MENUSET 640,1,175,120,240,170
F02000019MENUTITLE 640,25,17,"BK"
F02000020MENUSET 641,1,175,55,240,115
F02000021MENUTITLE 641,22,22,"BKS"
F02000022MENUSET 67,1,175,15,240,50
F02000023MENUTITLE 67,22,9,"GAR"
F02000024MENUSET 631,1,175,210,305,225
F02000025MENUTITLE 631,58,0,"LL"
F02000026FONT 0,0
F02000027GLOCATE 20,110
F02000028GPRINT "   MDE Shutter"
F02000029GLOCATE 20,126
F02000030GPRINT "      V1.1.0"
F02000031STYLE 0,0,0
F02000032MENUSET 97,2,5,200,80,235
F02000033MENUTITLE 97,16,9,"ALL UP"
F02000034MENUSET 98,2,85,200,160,235
F02000035MENUTITLE 98,9,9,"ALL DOWN"
F02000036BOX 5,150,160,195
F02000037FONT 0,1
F02000038STYLE 2,0,0
F02000039MENUSET 75,1,10,155,80,190
F02000040MENUTITLE 75,10,9,"Bov WRK"
F02000041MENUSET 79,1,90,155,155,190
F02000042MENUTITLE 79,7,9,"Bov SLK"
F02000043MENUSET 100,1,10,5,75,90
F02000044MENUTITLE 100,25,34,"UP"
F02000045MENUSET 101,1,90,5,155,90
F02000046MENUTITLE 101,18,34,"DOWN"
F02000047BOX 5,0,160,95
F02000048FONT 4,0
F02000049STYLE 0,0,0
F02000050END SUB
F99000000End
F99000021Sub Pulsout(__pt As Byte, __ln As Word)
F99000022Dim __dl1 As Integer
F99000023Reverse __pt
F99000024For __dl1=0 To __ln
F99000025Next
F99000026Reverse __pt
F99000027End Sub
F99000030Sub Delay(__dl As Long)
F99000031__dl1 Var Long
F99000032__dl2 Var Integer
F99000033For __dl1=0 To __dl
F99000034For __dl2=0 To 1
F99000035Nop
F99000036Nop
F99000037Nop
F99000038Next
F99000039Next
F99000040End Sub